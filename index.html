<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="本地浏览器中的 Excel / CSV 表格合并与数据处理工具，支持 JOIN、筛选、排序等多种操作。">
  <title>Excel 表格合并（类似数据库 JOIN）</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <a class="skip-link" href="#mainContent">跳至主要内容</a>
  <header class="app-header" role="banner">
    <h1>Excel/CSV 表格合并</h1>
    <nav class="header-actions" aria-label="页面操作">
      <button id="resetApp" type="button" class="btn ghost" title="重置页面">重置 <span class="shortcut-hint">Ctrl+R</span></button>
      <a class="btn link" href="https://github.com/" target="_blank" rel="noreferrer">GitHub</a>
    </nav>
  </header>

  <main id="mainContent" class="container" role="main">
    <!-- 模式切换 -->
    <section class="card mode-selector-card">
      <h2>🎯 选择处理模式</h2>
      <div class="mode-selector">
        <button id="dualTableMode" type="button" class="mode-btn active" data-mode="dual">
          <span class="mode-icon">🔗</span>
          <span class="mode-title">双表合并</span>
          <span class="mode-desc">合并两张不同的表格</span>
        </button>
        <button id="singleTableMode" type="button" class="mode-btn" data-mode="single">
          <span class="mode-icon">📊</span>
          <span class="mode-title">单表处理</span>
          <span class="mode-desc">处理单张表格的多个工作表</span>
        </button>
      </div>
    </section>

    <!-- ========== 双表合并模式 ========== -->
    <section id="dualTableSection" class="workflow-section" aria-labelledby="dual-table-heading">
      <header class="section-header">
        <h2 id="dual-table-heading">双表合并模式</h2>
        <p class="section-hint">将两份 Excel/CSV 数据进行 JOIN 合并。</p>
      </header>

      <article class="card">
        <h3>📂 上传数据文件</h3>
        <div class="upload-grid">
          <section class="upload-item" aria-labelledby="uploadLabelA">
            <label id="uploadLabelA" class="label" for="fileA">左表文件 (A)</label>
            <div id="dropzoneA" class="dropzone" role="group" aria-label="左表文件上传区域">
              <div class="dropzone-content">
                <span class="dropzone-icon">📄</span>
                <span class="dropzone-text">拖拽或点击选择</span>
              </div>
              <input id="fileA" type="file" accept=".xlsx,.xls,.csv" title="选择左表文件" aria-label="选择左表文件">
            </div>
            <div class="file-info" id="fileInfoA" aria-live="polite"></div>
            <div class="file-options">
              <label for="sheetA" class="mini-label">工作表：</label>
              <select id="sheetA" title="选择左表工作表" aria-label="选择左表工作表"></select>
              <button id="previewA" type="button" class="btn small outline">预览</button>
            </div>
          </section>
          <section class="upload-item" aria-labelledby="uploadLabelB">
            <label id="uploadLabelB" class="label" for="fileB">右表文件 (B)</label>
            <div id="dropzoneB" class="dropzone" role="group" aria-label="右表文件上传区域">
              <div class="dropzone-content">
                <span class="dropzone-icon">📄</span>
                <span class="dropzone-text">拖拽或点击选择</span>
              </div>
              <input id="fileB" type="file" accept=".xlsx,.xls,.csv" title="选择右表文件" aria-label="选择右表文件">
            </div>
            <div class="file-info" id="fileInfoB" aria-live="polite"></div>
            <div class="file-options">
              <label for="sheetB" class="mini-label">工作表：</label>
              <select id="sheetB" title="选择右表工作表" aria-label="选择右表工作表"></select>
              <button id="previewB" type="button" class="btn small outline">预览</button>
            </div>
          </section>
        </div>
        <div class="checkbox-row">
          <label for="hasHeader"><input id="hasHeader" type="checkbox" checked> 首行作为表头</label>
        </div>
      </article>

      <article class="card">
        <h3>🔗 选择合并键与类型</h3>
        <div class="keys-grid">
          <section class="keys-section" aria-labelledby="keysALabel">
            <h4 id="keysALabel" class="label">左表键列</h4>
            <div id="keysA" class="chips" role="group" aria-label="左表可选键列"></div>
          </section>
          <section class="keys-section" aria-labelledby="keysBLabel">
            <h4 id="keysBLabel" class="label">右表键列</h4>
            <div id="keysB" class="chips" role="group" aria-label="右表可选键列"></div>
          </section>
        </div>
        <div class="join-config">
          <div class="join-config-item">
            <label for="joinType" class="label">Join 类型</label>
            <select id="joinType" title="选择合并类型" aria-label="选择合并类型">
              <option value="inner">INNER JOIN（交集）</option>
              <option value="left">LEFT JOIN（左表全部）</option>
              <option value="right">RIGHT JOIN（右表全部）</option>
              <option value="full">FULL OUTER JOIN（并集）</option>
            </select>
          </div>
          <div class="join-config-item">
            <label for="nullFill" class="label">空值填充</label>
            <input id="nullFill" type="text" placeholder="例如：NULL" value="" title="设置空值填充" aria-label="设置空值填充">
          </div>
          <div class="help-tooltip" role="note">
            <span class="help-icon" aria-hidden="true">❓</span>
            <div class="tooltip-text">
              <strong>Join 类型说明：</strong><br>
              • INNER: 只保留两表都有的记录<br>
              • LEFT: 保留左表全部 + 右表匹配<br>
              • RIGHT: 保留右表全部 + 左表匹配<br>
              • FULL: 保留两表所有记录
            </div>
          </div>
        </div>
        <div class="action-buttons" role="group" aria-label="合并操作">
          <button id="runJoin" type="button" class="btn primary large">✨ 执行合并 <span class="shortcut-hint">Ctrl+Enter</span></button>
          <button id="saveHistory" type="button" class="btn outline">💾 保存到历史</button>
          <button id="saveAsTemplate" type="button" class="btn outline">📋 保存为模板</button>
          <button id="batchProcess" type="button" class="btn outline">📦 批量处理</button>
        </div>
      </article>
    </section>

    <!-- ========== 单表处理模式 ========== -->
    <section id="singleTableSection" class="workflow-section" aria-labelledby="single-table-heading" hidden>
      <header class="section-header">
        <h2 id="single-table-heading">单表处理模式</h2>
        <p class="section-hint">针对单个 Excel/CSV 文件的多工作表进行处理与合并。</p>
      </header>

      <article class="card">
        <h3>📂 上传单张表格</h3>
        <div class="single-upload">
          <div id="dropzoneSingle" class="dropzone" role="group" aria-label="单表文件上传区域">
            <div class="dropzone-content">
              <span class="dropzone-icon">📄</span>
              <span class="dropzone-text">拖拽Excel/CSV文件到此处或点击选择</span>
            </div>
            <input id="fileSingle" type="file" accept=".xlsx,.xls,.csv" title="选择单表文件" aria-label="选择单表文件">
          </div>
          <div class="file-info" id="fileInfoSingle" aria-live="polite"></div>
          <div class="checkbox-row">
            <label for="hasHeaderSingle"><input id="hasHeaderSingle" type="checkbox" checked> 首行作为表头</label>
          </div>
        </div>
      </article>

      <article class="card" id="singleTableSheets" hidden>
        <h3>📋 工作表管理</h3>
        <p class="section-hint">点击选择需要处理的工作表</p>
        <div class="sheets-grid" id="sheetsGrid" aria-live="polite"></div>
        
        <!-- 键列选择区域（仅在选择2个工作表时显示） -->
        <section id="singleTableKeys" class="single-keys-section" hidden aria-label="JOIN 合并设置">
          <div class="keys-divider" aria-hidden="true"></div>
          <h4>🔗 JOIN 合并设置</h4>
          <div class="keys-grid">
            <section class="keys-section" aria-labelledby="singleKeysALabel">
              <h5 id="singleKeysALabel" class="label">第一个工作表键列</h5>
              <div id="singleKeysA" class="chips" role="group" aria-label="第一个工作表键列"></div>
            </section>
            <section class="keys-section" aria-labelledby="singleKeysBLabel">
              <h5 id="singleKeysBLabel" class="label">第二个工作表键列</h5>
              <div id="singleKeysB" class="chips" role="group" aria-label="第二个工作表键列"></div>
            </section>
          </div>
          <div class="join-config">
            <div class="join-config-item">
              <label class="label" for="singleJoinType">合并类型</label>
              <select id="singleJoinType" title="选择合并类型" aria-label="选择合并类型">
                <option value="inner">内连接 (INNER JOIN) - 仅保留匹配的行</option>
                <option value="left">左连接 (LEFT JOIN) - 保留第一个表的所有行</option>
                <option value="right">右连接 (RIGHT JOIN) - 保留第二个表的所有行</option>
                <option value="full">全连接 (FULL JOIN) - 保留两表的所有行</option>
              </select>
            </div>
            <div class="join-config-item">
              <label class="label" for="singleNullFill">空值填充</label>
              <input id="singleNullFill" type="text" placeholder="留空表示空值" title="空值填充" aria-label="空值填充">
            </div>
          </div>
        </section>
        
        <div class="action-buttons" role="group" aria-label="单表操作">
          <button id="mergeAllSheets" type="button" class="btn primary large">🔄 合并工作表</button>
          <button id="processSelectedSheets" type="button" class="btn outline">⚙️ 处理选中</button>
          <button id="exportSelectedSheets" type="button" class="btn outline">📥 导出选中</button>
        </div>
      </article>
    </section>

    <!-- ========== 通用结果展示区域 ========== -->
    <!-- 数据处理操作（双表模式也显示） -->
    <section class="card shared-section" id="dataOperations" hidden>
      <h2>🛠️ 数据处理操作</h2>
      <p class="section-hint">对合并后的数据进行筛选、排序、清洗等操作</p>
      <div class="operations-grid">
        <div class="operation-card">
          <div class="operation-header">
            <span class="operation-icon">🔍</span>
            <h3>数据筛选</h3>
          </div>
          <div class="operation-content">
            <label class="label">筛选列</label>
            <select id="filterColumn" title="选择要筛选的列" aria-label="选择要筛选的列"></select>
            <label class="label">筛选条件</label>
            <select id="filterCondition" title="选择筛选条件" aria-label="选择筛选条件">
              <option value="equals">等于</option>
              <option value="contains">包含</option>
              <option value="starts_with">开头是</option>
              <option value="ends_with">结尾是</option>
              <option value="greater">大于</option>
              <option value="less">小于</option>
              <option value="not_empty">非空</option>
            </select>
            <label class="label">筛选值</label>
            <input id="filterValue" type="text" placeholder="输入筛选值" />
            <div class="operation-actions">
              <button id="applyFilter" type="button" class="btn small primary">应用筛选</button>
              <button id="clearFilterBtn" type="button" class="btn small outline">清除筛选</button>
            </div>
          </div>
        </div>
        
        <div class="operation-card">
          <div class="operation-header">
            <span class="operation-icon">📊</span>
            <h3>数据排序</h3>
          </div>
          <div class="operation-content">
            <label class="label">排序列</label>
            <select id="sortColumn" title="选择要排序的列" aria-label="选择要排序的列"></select>
            <label class="label">排序方式</label>
            <select id="sortOrder" title="选择排序方式" aria-label="选择排序方式">
              <option value="asc">升序</option>
              <option value="desc">降序</option>
            </select>
            <div class="operation-actions">
              <button id="applySort" type="button" class="btn small primary">应用排序</button>
            </div>
          </div>
        </div>
        
        <div class="operation-card">
          <div class="operation-header">
            <span class="operation-icon">🧹</span>
            <h3>数据清洗</h3>
          </div>
          <div class="operation-content">
            <label class="label">清洗操作</label>
            <select id="cleanupOperation" title="选择清洗操作类型" aria-label="选择清洗操作类型">
              <option value="remove_duplicates">去除重复行</option>
              <option value="remove_empty_rows">删除空行</option>
              <option value="trim_whitespace">去除首尾空格</option>
              <option value="fill_empty">填充空值</option>
            </select>
            <input id="fillValue" type="text" placeholder="填充值" hidden />
            <div class="operation-actions">
              <button id="applyCleanup" type="button" class="btn small primary">执行清洗</button>
            </div>
          </div>
        </div>
        
        <div class="operation-card">
          <div class="operation-header">
            <span class="operation-icon">📈</span>
            <h3>数据透视</h3>
          </div>
          <div class="operation-content">
            <label class="label">行字段</label>
            <select id="pivotRows" title="选择透视表行字段" aria-label="选择透视表行字段"></select>
            <label class="label">列字段</label>
            <select id="pivotColumns" title="选择透视表列字段" aria-label="选择透视表列字段"></select>
            <label class="label">值字段</label>
            <select id="pivotValues" title="选择透视表值字段" aria-label="选择透视表值字段"></select>
            <div class="operation-actions">
              <button id="createPivot" type="button" class="btn small primary">创建透视表</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 撤销/重做按钮 -->
      <div class="undo-section">
        <button id="undoOperation" type="button" class="btn outline" disabled>↶ 撤销操作</button>
        <button id="redoOperation" type="button" class="btn outline" disabled>↷ 重做操作</button>
        <span id="operationHistory" class="operation-history-text" aria-live="polite"></span>
      </div>
    </section>

    <!-- 数据统计 -->
    <section class="card shared-section" id="statsSection" hidden>
      <h2>📊 数据统计</h2>
      <div id="dataStats" class="data-stats-grid"></div>
    </section>

    <!-- 结果预览与导出 -->
    <section class="card shared-section" id="previewSection" hidden>
      <h2>📋 结果预览与导出</h2>
      <div class="preview-toolbar">
        <div id="stats" class="stats" aria-live="polite"></div>
        <div class="preview-actions">
          <input id="searchTable" type="text" placeholder="🔍 搜索表格..." title="搜索表格内容" aria-label="搜索表格内容" />
          <button id="clearSearchBtn" type="button" class="btn small outline" title="清除搜索">清除</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="preview"></table>
      </div>
      <div class="action-buttons" role="group" aria-label="导出格式选择">
        <button id="exportCSV" type="button" class="btn outline">📥 导出 CSV</button>
        <button id="exportXLSX" type="button" class="btn outline">📥 导出 XLSX</button>
        <button id="exportJSON" type="button" class="btn outline">📥 导出 JSON</button>
      </div>
    </section>

    <!-- 历史记录 -->
    <section class="card shared-section" id="historySection" hidden>
      <h2>🕒 历史记录</h2>
      <div id="historyList" class="history-list" aria-live="polite"></div>
    </section>

    <!-- 保存的模板 -->
    <section class="card shared-section" id="templatesSection" hidden>
      <h2>📋 保存的模板</h2>
      <div id="templatesList" class="templates-list"></div>
    </section>
  </main>

  <footer class="footer">
    <span>本地浏览器完成解析与合并，不上传任何数据。</span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
          integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
          integrity="sha512-r22gChDnGvBylk90+2e/ycr+eququ8+Par6G4NGr3OFxUo+qZ4rnXX9Ew+1PD6a81p0kJE9VVE0fI3LoN8Q0HA=="
          crossorigin="anonymous"></script>
  <script src="script.js"></script>
</body>
</html>
