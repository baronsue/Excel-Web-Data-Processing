<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Excel 表格合并（类似数据库 JOIN）</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <header class="app-header">
    <h1>Excel/CSV 表格合并</h1>
    <div class="header-actions">
      <button id="resetApp" class="btn ghost" title="重置页面">重置 <span class="shortcut-hint">Ctrl+R</span></button>
      <a class="btn link" href="https://github.com/" target="_blank" rel="noreferrer">GitHub</a>
    </div>
  </header>

  <main class="container">
    <!-- 模式切换 -->
    <section class="card mode-selector-card">
      <h2>🎯 选择处理模式</h2>
      <div class="mode-selector">
        <button id="dualTableMode" class="mode-btn active" data-mode="dual">
          <span class="mode-icon">🔗</span>
          <span class="mode-title">双表合并</span>
          <span class="mode-desc">合并两张不同的表格</span>
        </button>
        <button id="singleTableMode" class="mode-btn" data-mode="single">
          <span class="mode-icon">📊</span>
          <span class="mode-title">单表处理</span>
          <span class="mode-desc">处理单张表格的多个工作表</span>
        </button>
      </div>
    </section>

    <!-- ========== 双表合并模式 ========== -->
    <div id="dualTableSection">
      <!-- 上传文件 -->
      <section class="card">
        <h2>📂 上传数据文件</h2>
        <div class="upload-grid">
          <div class="upload-item">
            <label class="label">左表文件 (A)</label>
            <div id="dropzoneA" class="dropzone">
              <div class="dropzone-content">
                <span class="dropzone-icon">📄</span>
                <span class="dropzone-text">拖拽或点击选择</span>
              </div>
              <input id="fileA" type="file" accept=".xlsx,.xls,.csv" title="选择左表文件" aria-label="选择左表文件" />
            </div>
            <div class="file-info" id="fileInfoA"></div>
            <div class="file-options">
              <label for="sheetA" class="mini-label">工作表：</label>
              <select id="sheetA" title="选择左表工作表" aria-label="选择左表工作表"></select>
              <button id="previewA" class="btn small outline">预览</button>
            </div>
          </div>
          <div class="upload-item">
            <label class="label">右表文件 (B)</label>
            <div id="dropzoneB" class="dropzone">
              <div class="dropzone-content">
                <span class="dropzone-icon">📄</span>
                <span class="dropzone-text">拖拽或点击选择</span>
              </div>
              <input id="fileB" type="file" accept=".xlsx,.xls,.csv" title="选择右表文件" aria-label="选择右表文件" />
            </div>
            <div class="file-info" id="fileInfoB"></div>
            <div class="file-options">
              <label for="sheetB" class="mini-label">工作表：</label>
              <select id="sheetB" title="选择右表工作表" aria-label="选择右表工作表"></select>
              <button id="previewB" class="btn small outline">预览</button>
            </div>
          </div>
        </div>
        <div class="checkbox-row">
          <label><input id="hasHeader" type="checkbox" checked /> 首行作为表头</label>
        </div>
      </section>

      <!-- 键列与合并设置 -->
      <section class="card">
        <h2>🔗 选择合并键与类型</h2>
        <div class="keys-grid">
          <div class="keys-section">
            <label class="label">左表键列</label>
            <div id="keysA" class="chips"></div>
          </div>
          <div class="keys-section">
            <label class="label">右表键列</label>
            <div id="keysB" class="chips"></div>
          </div>
        </div>
        <div class="join-config">
          <div class="join-config-item">
            <label for="joinType" class="label">Join 类型</label>
            <select id="joinType" title="选择合并类型" aria-label="选择合并类型">
              <option value="inner">INNER JOIN（交集）</option>
              <option value="left">LEFT JOIN（左表全部）</option>
              <option value="right">RIGHT JOIN（右表全部）</option>
              <option value="full">FULL OUTER JOIN（并集）</option>
            </select>
          </div>
          <div class="join-config-item">
            <label for="nullFill" class="label">空值填充</label>
            <input id="nullFill" type="text" placeholder="例如：NULL" value="" title="设置空值填充" aria-label="设置空值填充" />
          </div>
          <div class="help-tooltip">
            <span class="help-icon">❓</span>
            <div class="tooltip-text">
              <strong>Join 类型说明：</strong><br>
              • INNER: 只保留两表都有的记录<br>
              • LEFT: 保留左表全部 + 右表匹配<br>
              • RIGHT: 保留右表全部 + 左表匹配<br>
              • FULL: 保留两表所有记录
            </div>
          </div>
        </div>
        <div class="action-buttons">
          <button id="runJoin" class="btn primary large">✨ 执行合并 <span class="shortcut-hint">Ctrl+Enter</span></button>
          <button id="saveHistory" class="btn outline">💾 保存到历史</button>
          <button onclick="saveAsTemplate()" class="btn outline">📋 保存为模板</button>
          <button onclick="batchProcess()" class="btn outline">📦 批量处理</button>
        </div>
      </section>
    </div>

    <!-- ========== 单表处理模式 ========== -->
    <div id="singleTableSection" style="display: none;">
      <!-- 上传文件 -->
      <section class="card">
        <h2>📂 上传单张表格</h2>
        <div class="single-upload">
          <div id="dropzoneSingle" class="dropzone">
            <div class="dropzone-content">
              <span class="dropzone-icon">📄</span>
              <span class="dropzone-text">拖拽Excel/CSV文件到此处或点击选择</span>
            </div>
            <input id="fileSingle" type="file" accept=".xlsx,.xls,.csv" title="选择单表文件" aria-label="选择单表文件" />
          </div>
          <div class="file-info" id="fileInfoSingle"></div>
          <div class="checkbox-row">
            <label><input id="hasHeaderSingle" type="checkbox" checked /> 首行作为表头</label>
          </div>
        </div>
      </section>

      <!-- 工作表管理 -->
      <section class="card" id="singleTableSheets" style="display: none;">
        <h2>📋 工作表管理</h2>
        <p class="section-hint">点击选择需要处理的工作表</p>
        <div class="sheets-grid" id="sheetsGrid"></div>
        
        <!-- 键列选择区域（仅在选择2个工作表时显示） -->
        <div id="singleTableKeys" class="single-keys-section" style="display: none;">
          <div class="keys-divider"></div>
          <h3>🔗 JOIN 合并设置</h3>
          <div class="keys-grid">
            <div class="keys-section">
              <label class="label">第一个工作表键列</label>
              <div id="singleKeysA" class="chips"></div>
            </div>
            <div class="keys-section">
              <label class="label">第二个工作表键列</label>
              <div id="singleKeysB" class="chips"></div>
            </div>
          </div>
          <div class="join-config">
            <div class="join-config-item">
              <label class="label" for="singleJoinType">合并类型</label>
              <select id="singleJoinType" title="选择合并类型" aria-label="选择合并类型">
                <option value="inner">内连接 (INNER JOIN) - 仅保留匹配的行</option>
                <option value="left">左连接 (LEFT JOIN) - 保留第一个表的所有行</option>
                <option value="right">右连接 (RIGHT JOIN) - 保留第二个表的所有行</option>
                <option value="full">全连接 (FULL JOIN) - 保留两表的所有行</option>
              </select>
            </div>
            <div class="join-config-item">
              <label class="label" for="singleNullFill">空值填充</label>
              <input id="singleNullFill" type="text" placeholder="留空表示空值" title="空值填充" aria-label="空值填充" />
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button id="mergeAllSheets" class="btn primary large">🔄 合并工作表</button>
          <button id="processSelectedSheets" class="btn outline">⚙️ 处理选中</button>
          <button id="exportSelectedSheets" class="btn outline">📥 导出选中</button>
        </div>
      </section>

      <!-- 数据处理操作 -->
      <section class="card" id="singleTableOperations" style="display: none;">
        <h2>🛠️ 数据处理操作</h2>
        <p class="section-hint">对合并后的数据进行筛选、排序、清洗等操作</p>
        <div class="operations-grid">
          <div class="operation-card">
            <div class="operation-header">
              <span class="operation-icon">🔍</span>
              <h3>数据筛选</h3>
            </div>
            <div class="operation-content">
              <label class="label">筛选列</label>
              <select id="filterColumn"></select>
              <label class="label">筛选条件</label>
              <select id="filterCondition">
                <option value="equals">等于</option>
                <option value="contains">包含</option>
                <option value="starts_with">开头是</option>
                <option value="ends_with">结尾是</option>
                <option value="greater">大于</option>
                <option value="less">小于</option>
                <option value="not_empty">非空</option>
              </select>
              <label class="label">筛选值</label>
              <input id="filterValue" type="text" placeholder="输入筛选值" />
              <div class="operation-actions">
                <button id="applyFilter" class="btn small primary">应用筛选</button>
                <button id="clearFilter" class="btn small outline">清除筛选</button>
              </div>
            </div>
          </div>
          
          <div class="operation-card">
            <div class="operation-header">
              <span class="operation-icon">📊</span>
              <h3>数据排序</h3>
            </div>
            <div class="operation-content">
              <label class="label">排序列</label>
              <select id="sortColumn"></select>
              <label class="label">排序方式</label>
              <select id="sortOrder">
                <option value="asc">升序</option>
                <option value="desc">降序</option>
              </select>
              <div class="operation-actions">
                <button id="applySort" class="btn small primary">应用排序</button>
              </div>
            </div>
          </div>
          
          <div class="operation-card">
            <div class="operation-header">
              <span class="operation-icon">🧹</span>
              <h3>数据清洗</h3>
            </div>
            <div class="operation-content">
              <label class="label">清洗操作</label>
              <select id="cleanupOperation">
                <option value="remove_duplicates">去除重复行</option>
                <option value="remove_empty_rows">删除空行</option>
                <option value="trim_whitespace">去除首尾空格</option>
                <option value="fill_empty">填充空值</option>
              </select>
              <input id="fillValue" type="text" placeholder="填充值" style="display: none;" />
              <div class="operation-actions">
                <button id="applyCleanup" class="btn small primary">执行清洗</button>
              </div>
            </div>
          </div>
          
          <div class="operation-card">
            <div class="operation-header">
              <span class="operation-icon">📈</span>
              <h3>数据透视</h3>
            </div>
            <div class="operation-content">
              <label class="label">行字段</label>
              <select id="pivotRows"></select>
              <label class="label">列字段</label>
              <select id="pivotColumns"></select>
              <label class="label">值字段</label>
              <select id="pivotValues"></select>
              <div class="operation-actions">
                <button id="createPivot" class="btn small primary">创建透视表</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ========== 通用结果展示区域 ========== -->
    <!-- 数据统计 -->
    <section class="card">
      <h2>📊 数据统计</h2>
      <div id="dataStats" class="data-stats-grid"></div>
    </section>

    <!-- 结果预览与导出 -->
    <section class="card">
      <h2>📋 结果预览与导出</h2>
      <div class="preview-toolbar">
        <div id="stats" class="stats"></div>
        <div class="preview-actions">
          <input id="searchTable" type="text" placeholder="🔍 搜索表格..." title="搜索表格内容" aria-label="搜索表格内容" />
          <button id="clearSearchBtn" class="btn small outline" title="清除搜索">清除</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="preview"></table>
      </div>
      <div class="action-buttons">
        <button id="exportCSV" class="btn outline">📥 导出 CSV</button>
        <button id="exportXLSX" class="btn outline">📥 导出 XLSX</button>
        <button id="exportJSON" class="btn outline">📥 导出 JSON</button>
      </div>
    </section>

    <!-- 历史记录 -->
    <section class="card" id="historySection" style="display: none;">
      <h2>🕒 历史记录</h2>
      <div id="historyList" class="history-list"></div>
    </section>

    <!-- 保存的模板 -->
    <section class="card" id="templatesSection" style="display: none;">
      <h2>📋 保存的模板</h2>
      <div id="templatesList" class="templates-list"></div>
    </section>
  </main>

  <footer class="footer">
    <span>本地浏览器完成解析与合并，不上传任何数据。</span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="script.js"></script>
</body>
</html>
